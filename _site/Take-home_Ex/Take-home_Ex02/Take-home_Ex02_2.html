<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-02-29">

<title>Bin Hui’s IS415-GAA Journal - Take-home Exercise 2: Application of Spatial and Spatio-temporal Analysis Methods to Discover the Distribution of Dengue Fever in Tainan City, Taiwan (Part 2)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="../../site_libs/plotly-binding-4.10.3/plotly.js"></script>
<script src="../../site_libs/typedarray-0.1/typedarray.min.js"></script>
<script src="../../site_libs/jquery-3.5.1/jquery.min.js"></script>
<link href="../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<link href="../../site_libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="../../site_libs/plotly-main-2.11.1/plotly-latest.min.js"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Bin Hui’s IS415-GAA Journal</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hands-on-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Hands-on Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-hands-on-exercise">    
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex01/Hands-on_Ex01.html" rel="" target="">
 <span class="dropdown-text">Hands-on Exercise 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex02/Hands-on_Ex02.html" rel="" target="">
 <span class="dropdown-text">Hands-on Exercise 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex03/Hands-on_Ex03.html" rel="" target="">
 <span class="dropdown-text">Hands-on Exercise 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex04/Hands-on_Ex04.html" rel="" target="">
 <span class="dropdown-text">Hands-on Exercise 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex05/Hands-on_Ex05.html" rel="" target="">
 <span class="dropdown-text">Hands-on Exercise 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex06/Hands-on_Ex06.html" rel="" target="">
 <span class="dropdown-text">Hands-on Exercise 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex07/Hands-on_Ex07.html" rel="" target="">
 <span class="dropdown-text">Hands-on Exercise 7</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-in-class-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">In-class Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-in-class-exercise">    
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex02/In-class_Ex02.html" rel="" target="">
 <span class="dropdown-text">In-class Exercise 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex03/In-class_Ex03.html" rel="" target="">
 <span class="dropdown-text">In-class Exercise 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex04/In-class_Ex04.html" rel="" target="">
 <span class="dropdown-text">In-class Exercise 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex05/In-class_Ex05.html" rel="" target="">
 <span class="dropdown-text">In-class Exercise 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex06/In-class_Ex06.html" rel="" target="">
 <span class="dropdown-text">In-class Exercise 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex07/In-class_Ex07.html" rel="" target="">
 <span class="dropdown-text">In-class Exercise 6</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-take-home-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Take-home Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-take-home-exercise">    
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex01/Take-home_Ex01.html" rel="" target="">
 <span class="dropdown-text">Take-home Exercise 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex02/Take-home_Ex02.html" rel="" target="">
 <span class="dropdown-text">Take-home Exercise 2 (Part 1)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex02/Take-home_Ex02_2.html" rel="" target="">
 <span class="dropdown-text">Take-home Exercise 2 (Part 2)</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About Me</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#local-spatial-autocorrelation-analysis" id="toc-local-spatial-autocorrelation-analysis" class="nav-link active" data-scroll-target="#local-spatial-autocorrelation-analysis">6 Local Spatial Autocorrelation Analysis</a>
  <ul class="collapse">
  <li><a href="#computing-lisa" id="toc-computing-lisa" class="nav-link" data-scroll-target="#computing-lisa">6.1: Computing LISA</a></li>
  <li><a href="#visualizing-local-morans-i" id="toc-visualizing-local-morans-i" class="nav-link" data-scroll-target="#visualizing-local-morans-i">6.2: Visualizing local Moran’s I</a></li>
  <li><a href="#visualizing-p-value-of-locals-moran-i" id="toc-visualizing-p-value-of-locals-moran-i" class="nav-link" data-scroll-target="#visualizing-p-value-of-locals-moran-i">6.3: Visualizing p-value of local’s Moran I</a></li>
  <li><a href="#visualizing-local-morans-i-and-p-value" id="toc-visualizing-local-morans-i-and-p-value" class="nav-link" data-scroll-target="#visualizing-local-morans-i-and-p-value">6.4: Visualizing local moran’s I and p-value</a></li>
  <li><a href="#visualizing-lisa-map" id="toc-visualizing-lisa-map" class="nav-link" data-scroll-target="#visualizing-lisa-map">6.5 Visualizing LISA map</a></li>
  </ul></li>
  <li><a href="#emerging-hotspot-analysis-ehsa" id="toc-emerging-hotspot-analysis-ehsa" class="nav-link" data-scroll-target="#emerging-hotspot-analysis-ehsa">7 Emerging Hotspot Analysis (EHSA)</a>
  <ul class="collapse">
  <li><a href="#preparing-spacetime-data" id="toc-preparing-spacetime-data" class="nav-link" data-scroll-target="#preparing-spacetime-data">7.1 Preparing spacetime data</a>
  <ul class="collapse">
  <li><a href="#data-manipulation" id="toc-data-manipulation" class="nav-link" data-scroll-target="#data-manipulation">7.1.1 Data manipulation</a></li>
  <li><a href="#building-space-time-cube" id="toc-building-space-time-cube" class="nav-link" data-scroll-target="#building-space-time-cube">7.1.2 Building space-time cube</a></li>
  </ul></li>
  <li><a href="#computing-local-gi-statistics" id="toc-computing-local-gi-statistics" class="nav-link" data-scroll-target="#computing-local-gi-statistics">7.2 Computing local Gi* statistics</a>
  <ul class="collapse">
  <li><a href="#deriving-spatial-weight-matrix" id="toc-deriving-spatial-weight-matrix" class="nav-link" data-scroll-target="#deriving-spatial-weight-matrix">7.2.1 Deriving spatial weight matrix</a></li>
  <li><a href="#computing-gi" id="toc-computing-gi" class="nav-link" data-scroll-target="#computing-gi">7.2.2 Computing Gi*</a></li>
  </ul></li>
  <li><a href="#mann-kendall-test" id="toc-mann-kendall-test" class="nav-link" data-scroll-target="#mann-kendall-test">7.3 Mann-Kendall Test</a></li>
  <li><a href="#performing-emerging-hotspot-analysis-ehsa" id="toc-performing-emerging-hotspot-analysis-ehsa" class="nav-link" data-scroll-target="#performing-emerging-hotspot-analysis-ehsa">7.4 Performing Emerging Hotspot Analysis (EHSA)</a>
  <ul class="collapse">
  <li><a href="#performing-ehsa" id="toc-performing-ehsa" class="nav-link" data-scroll-target="#performing-ehsa">7.4.1 Performing EHSA</a></li>
  <li><a href="#visualizing-the-distribution-of-ehsa-classes" id="toc-visualizing-the-distribution-of-ehsa-classes" class="nav-link" data-scroll-target="#visualizing-the-distribution-of-ehsa-classes">7.4.2 Visualizing the distribution of EHSA classes</a></li>
  <li><a href="#visualizing-ehsa" id="toc-visualizing-ehsa" class="nav-link" data-scroll-target="#visualizing-ehsa">7.4.3 Visualizing EHSA</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#reflection" id="toc-reflection" class="nav-link" data-scroll-target="#reflection">8 Reflection</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Take-home Exercise 2: Application of Spatial and Spatio-temporal Analysis Methods to Discover the Distribution of Dengue Fever in Tainan City, Taiwan (Part 2)</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 29, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p><strong><em>This webpage is a continuation of Take-home Exercise 2 (Part 1), which can be found <a href="https://is415-gaa-ongbinhui.netlify.app/take-home_ex/take-home_ex02/take-home_ex02">here</a>.</em></strong></p>
<p>Additional reference link for Section 7.3:</p>
<ul>
<li><a href="https://binhuiong.shinyapps.io/MannKendall_Tainan/">ShinyApp to select and compare Mann-Kendall test results for different villages</a></li>
</ul>
<p>Moving onto our next steps…</p>
<section id="local-spatial-autocorrelation-analysis" class="level1">
<h1>6 Local Spatial Autocorrelation Analysis</h1>
<p>After inferring that the number of dengue cases are not spatially randomly distributed across villages, it would be meaningful to detect clusters and outliers.</p>
<p>To do so, we would conduct local spatial autocorrelation analysis. Local spatial autocorrelation analysis delves deeper than its global counterpart, going beyond the overall pattern to examine spatial relationships at the <strong>individual location level</strong>. It investigates whether a specific location’s value is <strong>similar or dissimilar to the values of its surrounding locations</strong>. This provides a more granular and nuanced understanding of spatial clustering or dispersion.</p>
<p>Key points:</p>
<ul>
<li><p>Focuses on individual locations: It analyzes the relationship between a specific location and its neighbors, providing insights into local patterns that might be obscured in global analysis.</p></li>
<li><p>Identifies clusters and outliers: It allows identification of spatial clusters of similar or dissimilar values, as well as spatial outliers that deviate significantly from their neighbors.</p></li>
<li><p>Common statistics: Common local spatial autocorrelation statistics include Local Moran’s I and Getis-Ord G statistics. These statistics evaluate local deviations from spatial randomness for each location.</p></li>
</ul>
<section id="computing-lisa" class="level2">
<h2 class="anchored" data-anchor-id="computing-lisa">6.1: Computing LISA</h2>
<p>The first step in performing the local spatial autocorrelation analysis is deriving the Local Indicator of Spatial Association (LISA). The LISA for each observation gives an indication of the extent of significant spatial clustering of similar values around that observation.</p>
<p>To compute LISA, we can apply the following code.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>lisa <span class="ot">&lt;-</span> wm_q <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">local_moran =</span> <span class="fu">local_moran</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  total_cases, nb, wt, <span class="at">nsim =</span> <span class="dv">79</span>),</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(local_moran)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Components of code:</p>
<ul>
<li><p>mutate() from <strong>dplyr</strong> package to create a new column consisting of local_moran’s I statistics</p>
<ul>
<li><p>based on</p>
<ul>
<li><p>variable: total cases</p></li>
<li><p>number of simulations (79 + 1) = 80</p></li>
</ul></li>
</ul></li>
<li><p>unnest() from base R to expand the list-coumn containing the resulting data frame of local moran’s I statistics into columns</p></li>
</ul>
<p>Output of code (columns):</p>
<ul>
<li><p>ii: local moran statistic</p></li>
<li><p>eii: expectation of local moran statistic; for localmoran_permthe permutation sample means</p></li>
<li><p>var_ii: variance of local moran statistic; for localmoran_permthe permutation sample standard deviations</p></li>
<li><p>z_ii: standard deviate of local moran statistic; for localmoran_perm based on permutation sample means and standard deviations</p></li>
<li><p>p_ii: p-value of local moran statistic using pnorm(); for localmoran_perm using standard deviatse based on permutation sample means and standard deviations</p></li>
<li><p>p_ii_sim: For localmoran_perm(), rank() and punif() of observed statistic rank for [0, 1] p-values using alternative hypothesis</p></li>
<li><p>p_folded_sim: the simulation folded [0, 0.5] range ranked p-value (based on https://github.com/pysal/esda/blob/4a63e0b5df1e754b17b5f1205b cadcbecc5e061/esda/crand.py#L211-L213)</p></li>
<li><p>skewness: For localmoran_perm, the output of e1071::skewness() for the permutation samples underlying the standard deviates</p></li>
<li><p>kurtosis: For localmoran_perm, the output of e1071::kurtosis() for the permutation samples underlying the standard deviates.</p></li>
</ul>
</section>
<section id="visualizing-local-morans-i" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-local-morans-i">6.2: Visualizing local Moran’s I</h2>
<p>Then, we can create a choropleth map using <strong>tmap</strong> functions to visualize the local moran statistic (“ii”) of different villages.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(lisa) <span class="sc">+</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"ii"</span>) <span class="sc">+</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Local Moran's I of Total Cases"</span>, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.size =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="images/local morans i of total cases.png" class="img-fluid"></p>
<p>Interpreting Local Moran’s I (“ii”):</p>
<ul>
<li><p>Positive: Cluster (village is associated with relatively high values of surrounding villages)</p>
<ul>
<li>From the choropleth map, we can see quite a number of clusters in the Tainan City, especially more in the northern regions.</li>
</ul></li>
<li><p>Negative: Outlier (village is associated with relatively low values of surrounding villages)</p>
<ul>
<li>From the choropleth map, we can see a small outlier (orange) village that stands out.</li>
</ul></li>
</ul>
<p>But how significant are these clusters and outliers? To discover that, we will have to check their p-values, in the next step!</p>
</section>
<section id="visualizing-p-value-of-locals-moran-i" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-p-value-of-locals-moran-i">6.3: Visualizing p-value of local’s Moran I</h2>
<p>Here, we prepare a choropleth map using <strong>tmap</strong> functions to visualize the p-value of local moran statistic (“p_ii_sim”). of the different villages, to detect which villages are significant clusters/outliers.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(lisa) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"p_ii_sim"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="dv">1</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.001"</span>, <span class="st">"0.01"</span>, <span class="st">"0.05"</span>, <span class="st">"Not significant"</span>)) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span> (<span class="at">main.title =</span> <span class="st">"p-value of local Moran's I"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">main.title.size =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="images/p-value of local morans i.png" class="img-fluid"></p>
<p>From the choropleth map of p-values, we can see that many parts (more than half) of clusters and outliers discovered by the local moran’s I statistics are not significant at 95% confidence level. However, there are still a larger number of villages, particularly those in the northern and eastern regions, that exhibit significant clustering/outliers at 95% confidence level.</p>
</section>
<section id="visualizing-local-morans-i-and-p-value" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-local-morans-i-and-p-value">6.4: Visualizing local moran’s I and p-value</h2>
<p>Putting the local moran’s I value and p-value choropleth maps side by side allows to interpret out results more easily, tracing which villages are significant outliers or significant clusters on the map. To do so, we can use tmap_arrange() from <strong>tmap</strong> package to put the maps together, as demonstrated in the code chunk below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>local_mapi <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(lisa) <span class="sc">+</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"ii"</span>) <span class="sc">+</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Local Moran's I of Total Cases"</span>, </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.size =</span> <span class="fl">0.8</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>local_mapp <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(lisa) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"p_ii_sim"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="dv">1</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.001"</span>, <span class="st">"0.01"</span>, <span class="st">"0.05"</span>, <span class="st">"Not significant"</span>)) <span class="sc">+</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span> (<span class="at">main.title =</span> <span class="st">"p-value of local Moran's I"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">main.title.size =</span> <span class="fl">0.8</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_arrange</span>(local_mapi, local_mapp, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="images/local morans i.png" class="img-fluid"></p>
<p>An obvious group of regions that exhibit significant cluster patterns (at 95% confidence level) are the north-western regions of Tainan.</p>
</section>
<section id="visualizing-lisa-map" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-lisa-map">6.5 Visualizing LISA map</h2>
<p>LISA map is a categorical map showing outliers and clusters. There are two types of outliers namely: High-Low and Low-High outliers. Likewise, there are two type of clusters namely: High-High and Low-Low clusters. In fact, LISA map is an interpreted map by combining local Moran’s I of geographical areas and their respective p-values.</p>
<p>In lisa sf data.frame, we can find three fields contain the LISA categories. They are <em>mean</em>, <em>median</em> and <em>pysal</em>. In general, classification in <em>mean</em> will be used as shown in the code chunk below, highlighting only villages that exhibit significant clustering/outliers at 95% confidence level.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>lisa_sig <span class="ot">&lt;-</span> lisa <span class="sc">%&gt;%</span> <span class="fu">filter</span>(p_ii <span class="sc">&lt;</span><span class="fl">0.05</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(lisa) <span class="sc">+</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(lisa_sig) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"mean"</span>) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha=</span><span class="fl">0.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="images/lisa map.png" class="img-fluid"></p>
<p>The choropleth map tells us that :</p>
<ul>
<li><p>The north-western and north-eastern regions (in purple) of significant clusters make up of “low-low” clusters, forming clusters of low numbers of dengue cases.</p></li>
<li><p>On the other hand, some villages in the middle regions (red) make up significant clusters of “high-high” values, implying that they are clusters of high numbers of dengue cases.</p></li>
<li><p>There are a few villages of “low-high” outliers (purple), showing that they are villages with low numbers of dengue cases, surrounded by villages with higher numbers of dengue cases.</p></li>
</ul>
</section>
</section>
<section id="emerging-hotspot-analysis-ehsa" class="level1">
<h1>7 Emerging Hotspot Analysis (EHSA)</h1>
<p>Emerging hotspot analysis (EHSA) goes beyond traditional hotspot analysis by <strong>examining how spatial clusters of high or low values evolve over time</strong>. It identifies <strong>areas that are not currently hotspots but display a trend towards becoming one,</strong> providing valuable insights for proactive measures and prevention strategies.</p>
<p>Key points:</p>
<ul>
<li><p><strong>Focuses on trends:</strong> Analyzes changes in spatial clusters over time, identifying <strong>emerging hotspots</strong>, <strong>intensifying hotspots</strong>, and <strong>diminishing hotspots</strong> along with persistent and sporadic patterns.</p></li>
<li><p><strong>Proactive approach:</strong> Enables proactive measures as it identifies areas exhibiting <strong>early signs of becoming hotspots</strong>, allowing for interventions before the problem escalates.</p></li>
</ul>
<section id="preparing-spacetime-data" class="level2">
<h2 class="anchored" data-anchor-id="preparing-spacetime-data">7.1 Preparing spacetime data</h2>
<section id="data-manipulation" class="level3">
<h3 class="anchored" data-anchor-id="data-manipulation">7.1.1 Data manipulation</h3>
<p>To begin with, let’s combine our dengue observations based on epidemiology weeks. To do so, we can use group_by() and summarize() from <strong>dplyr</strong> package, and epiweek() from <strong>lubridate</strong> package.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dengue_epi_sf <span class="ot">&lt;-</span> dengue_sf <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(VILLENG, TOWNID, <span class="fu">epiweek</span>(發病日)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">cases=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the above code,</p>
<ul>
<li><p>group_by() groups our records according to the fields in the arguments, in ascending order by default, and in order starting with the first field indicated</p></li>
<li><p>summarize() creates a new field, returning one row of aggregated value for each combination of grouped variables</p></li>
<li><p>epiweek() extrac</p></li>
</ul>
<p>To build a space-time cube later, we can only define one field as the location field. Hence, we will need to create a new location field which is composed of VILLENG and TOWNID, separated by a comma. A new column can be created using mutate() of dplyr package, and the VILLENG and TOWNID fields can be combined using paste() from base R.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dengue_epi_sf <span class="ot">&lt;-</span> dengue_epi_sf <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">location =</span> <span class="fu">paste</span>(VILLENG, <span class="st">","</span>, TOWNID))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>One of the conditions of building a spacetime cube is that given a number of spatial features (which in this case, is our locations) n, and time periods m, a spatio-temporal full grid must have n X m rows. However, as our existing data only captures actual dengue cases that are recorded, days with 0 cases are not recorded. Therefore, we must insert the records where there are 0 cases by ourselves.</p>
<p>To do so, we can apply the following steps:</p>
<section id="step-1-create-a-full-grid" class="level4">
<h4 class="anchored" data-anchor-id="step-1-create-a-full-grid">Step 1: Create a full grid</h4>
<p>Applying the code below creates a tibble table that contains our desired complete n x m records.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>taiwanstudy_sf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"/Users/binhui-ong/IS415-GAA/Take-home_Ex/Take-home_Ex02/data/rds/taiwanstudy_sf.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dengue_full_sf <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">VILLENG =</span> <span class="fu">rep</span>(taiwanstudy_sf<span class="sc">$</span>VILLENG, <span class="dv">20</span>), </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">TOWNID =</span> <span class="fu">rep</span>(taiwanstudy_sf<span class="sc">$</span>TOWNID, <span class="dv">20</span>),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">geometry =</span> <span class="fu">rep</span>(taiwanstudy_sf<span class="sc">$</span>geometry, <span class="dv">20</span>),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">epiweek(發病日)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">31</span><span class="sc">:</span><span class="dv">50</span>), <span class="at">each =</span> <span class="dv">258</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">location =</span> <span class="fu">paste</span>(VILLENG, <span class="st">","</span> , TOWNID))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the above code:</p>
<ul>
<li><p>To fill in values for each column (i.e.&nbsp;VILLENG, TOWNID, geometry and epiweek(發病日)), we can use rep(), a Base R function.</p>
<ul>
<li><p>For VILLENG, TOWNID and geometry fields: It replicates the set (vector) of values input in the first argument, for as many times as stated in the second argument throughout the records.</p></li>
<li><p>For epiweek(發病日) field: It replicates each individual value in the vector in the first argument for the number of times indicated in the “each” argument, before replicating the next value in the vector the same way, functioning this way throughout all the records.</p></li>
</ul></li>
</ul>
</section>
<section id="step-2-join-the-existing-case-records-to-the-full-grid" class="level4">
<h4 class="anchored" data-anchor-id="step-2-join-the-existing-case-records-to-the-full-grid">Step 2: Join the existing case records to the full grid</h4>
<p>Here, we use left_join() from the <strong>dplyr</strong> package to insert our dengue case records in dengue_epi_sf into dengue_full_sf.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dengue_full_sf <span class="ot">&lt;-</span> dengue_full_sf <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(dengue_epi_sf, <span class="fu">join_by</span>(VILLENG, TOWNID, <span class="st">`</span><span class="at">epiweek(發病日)</span><span class="st">`</span>))  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Since we do not need the geometry.y column that is redundant and contains missing values, we can remove it using select() from <strong>dplyr</strong>, and rename geometry.x as geometry since it is our geometry column.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dengue_full_sf <span class="ot">&lt;-</span> dengue_full_sf <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>geometry.y, <span class="sc">-</span>location.y) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">geometry =</span> geometry.x, <span class="at">location =</span> location.x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dengue_full_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(VILLENG)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,160 × 6
   VILLENG     TOWNID                  geometry `epiweek(發病日)` location cases
   &lt;chr&gt;       &lt;chr&gt;              &lt;POLYGON [°]&gt;             &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt;
 1 Andong Vil. D06    ((120.2164 23.04019, 120…                31 Andong …     1
 2 Andong Vil. D06    ((120.2164 23.04019, 120…                32 Andong …    NA
 3 Andong Vil. D06    ((120.2164 23.04019, 120…                33 Andong …     2
 4 Andong Vil. D06    ((120.2164 23.04019, 120…                34 Andong …    NA
 5 Andong Vil. D06    ((120.2164 23.04019, 120…                35 Andong …     1
 6 Andong Vil. D06    ((120.2164 23.04019, 120…                36 Andong …     2
 7 Andong Vil. D06    ((120.2164 23.04019, 120…                37 Andong …     1
 8 Andong Vil. D06    ((120.2164 23.04019, 120…                38 Andong …     5
 9 Andong Vil. D06    ((120.2164 23.04019, 120…                39 Andong …     7
10 Andong Vil. D06    ((120.2164 23.04019, 120…                40 Andong …    14
# ℹ 5,150 more rows</code></pre>
</div>
</div>
<p>In the above code, I have displayed the records by alphabetical order of VILLNAMEs, for easier visualization here.</p>
<p>We can see that after the data wrangling, we have 5160 records, which corresponds to our 258 villages x 20 epidemiology weeks of observations. Looking into the table, there are some records with NA cases, which represent 0 cases for those corresponding weeks and villages.</p>
</section>
<section id="step-3-insert-0-values" class="level4">
<h4 class="anchored" data-anchor-id="step-3-insert-0-values">Step 3: Insert “0” values</h4>
<p>Next, we should replace the NA values with 0 to prevent further complications later on, and to make those records appear clearer. To do so, we can use replace_na() from the <strong>tidyr</strong> package.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dengue_full_sf<span class="sc">$</span>cases <span class="ot">&lt;-</span> <span class="fu">replace_na</span>(dengue_full_sf<span class="sc">$</span>cases, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dengue_full_sf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,160 × 6
   VILLENG     TOWNID                  geometry `epiweek(發病日)` location cases
   &lt;chr&gt;       &lt;chr&gt;              &lt;POLYGON [°]&gt;             &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt;
 1 Qingcao Vi… D06    ((120.1176 23.08387, 120…                31 Qingcao…     0
 2 Bao'an Vil. D32    ((120.2304 22.93544, 120…                31 Bao'an …     1
 3 Chihkan Vi… D08    ((120.2012 22.99966, 120…                31 Chihkan…     0
 4 Dacheng Vi… D02    ((120.1985 22.98147, 120…                31 Dacheng…     0
 5 Chengbei V… D06    ((120.1292 23.06512, 120…                31 Chengbe…     0
 6 Chengnan V… D06    ((120.1246 23.06904, 120…                31 Chengna…     0
 7 Fahua Vil.  D08    ((120.2094 22.98452, 120…                31 Fahua V…     0
 8 Hainan Vil. D06    ((120.175 23.02218, 120.…                31 Hainan …     0
 9 Guo'an Vil. D06    ((120.1866 23.02766, 120…                31 Guo'an …     0
10 Xixin Vil.  D06    ((120.1834 23.06086, 120…                31 Xixin V…     0
# ℹ 5,150 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="building-space-time-cube" class="level3">
<h3 class="anchored" data-anchor-id="building-space-time-cube">7.1.2 Building space-time cube</h3>
<p>Next, we will be building a space-time cube of our dengue data in the study areas of villages in Tainan City, across an epidemiology week of 31-50 in 2023.</p>
<p>Step 1: Prepare geometry data</p>
<p>Let’s create a location column, similar to in dengue_epi_sf, in our geometry data taiwanstudy_sf first:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>taiwanstudy_sf <span class="ot">&lt;-</span> taiwanstudy_sf <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">location =</span> <span class="fu">paste</span>(VILLENG, <span class="st">","</span>, TOWNID))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Step 2: Creating spacetime object</p>
<p>Here, we can create our spacetime object using spacetime() from <strong>sfdep</strong>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dengue_st <span class="ot">&lt;-</span> <span class="fu">spacetime</span>(dengue_full_sf, taiwanstudy_sf,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">.loc_col =</span> <span class="st">"location"</span>,<span class="at">.time_col =</span> <span class="st">"epiweek(發病日)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dengue_st</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,160 × 6
   VILLENG     TOWNID                  geometry `epiweek(發病日)` location cases
 * &lt;chr&gt;       &lt;chr&gt;              &lt;POLYGON [°]&gt;             &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt;
 1 Qingcao Vi… D06    ((120.1176 23.08387, 120…                31 Qingcao…     0
 2 Bao'an Vil. D32    ((120.2304 22.93544, 120…                31 Bao'an …     1
 3 Chihkan Vi… D08    ((120.2012 22.99966, 120…                31 Chihkan…     0
 4 Dacheng Vi… D02    ((120.1985 22.98147, 120…                31 Dacheng…     0
 5 Chengbei V… D06    ((120.1292 23.06512, 120…                31 Chengbe…     0
 6 Chengnan V… D06    ((120.1246 23.06904, 120…                31 Chengna…     0
 7 Fahua Vil.  D08    ((120.2094 22.98452, 120…                31 Fahua V…     0
 8 Hainan Vil. D06    ((120.175 23.02218, 120.…                31 Hainan …     0
 9 Guo'an Vil. D06    ((120.1866 23.02766, 120…                31 Guo'an …     0
10 Xixin Vil.  D06    ((120.1834 23.06086, 120…                31 Xixin V…     0
# ℹ 5,150 more rows</code></pre>
</div>
</div>
<p>To verify if the result is indeed a spacetime object,</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is_spacetime</span>(dengue_st)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>And whether it is a spacetime cube,</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is_spacetime_cube</span>(dengue_st)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>YAY! We’ve successfully created our spacetime cube, which is a spatio-tempotial full grid.</p>
</section>
</section>
<section id="computing-local-gi-statistics" class="level2">
<h2 class="anchored" data-anchor-id="computing-local-gi-statistics">7.2 Computing local Gi* statistics</h2>
<section id="deriving-spatial-weight-matrix" class="level3">
<h3 class="anchored" data-anchor-id="deriving-spatial-weight-matrix">7.2.1 Deriving spatial weight matrix</h3>
<p>Before we can compute local Gi* statistics, we would need to derive a spatial weight matrix. To do so, we can apply the following code below, using the functions of <strong>sfdep</strong> and <strong>dplyr</strong> packages.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>dengue_nb <span class="ot">&lt;-</span> dengue_st <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">activate</span>(<span class="st">"geometry"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nb =</span> <span class="fu">include_self</span>(<span class="fu">st_contiguity</span>(geometry)),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">wt =</span> <span class="fu">st_inverse_distance</span>(nb, geometry,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scale =</span> <span class="dv">50</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_nbs</span>(<span class="st">"nb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_wts</span>(<span class="st">"wt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the code above, activate() from dplyr package is used to activate the geometry context</p>
<ul>
<li><p>mutate() from <strong>dplyr</strong> package is usd to create two new columns nb and wt</p></li>
<li><p>set_nbs() and set_wts() are used to activate the data context again and copy the values to each time_slice</p></li>
<li><p>Now, our dataset has neighbours and weights for each time-slice.</p></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dengue_nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  VILLENG      TOWNID                  geometry `epiweek(發病日)` location cases
  &lt;chr&gt;        &lt;chr&gt;              &lt;POLYGON [°]&gt;             &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt;
1 Qingcao Vil. D06    ((120.1176 23.08387, 120…                31 Qingcao…     0
2 Bao'an Vil.  D32    ((120.2304 22.93544, 120…                31 Bao'an …     1
3 Chihkan Vil. D08    ((120.2012 22.99966, 120…                31 Chihkan…     0
4 Dacheng Vil. D02    ((120.1985 22.98147, 120…                31 Dacheng…     0
5 Chengbei Vi… D06    ((120.1292 23.06512, 120…                31 Chengbe…     0
6 Chengnan Vi… D06    ((120.1246 23.06904, 120…                31 Chengna…     0
# ℹ 2 more variables: nb &lt;list&gt;, wt &lt;list&gt;</code></pre>
</div>
</div>
</section>
<section id="computing-gi" class="level3">
<h3 class="anchored" data-anchor-id="computing-gi">7.2.2 Computing Gi*</h3>
<p>Next, we used the derived new columns to manually calculate the local Gi* for each location.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>gi_stars <span class="ot">&lt;-</span> dengue_nb <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="st">`</span><span class="at">epiweek(發病日)</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gi_star =</span> <span class="fu">local_gstar_perm</span>(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    cases, nb, wt)) <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(gi_star)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the above code:</p>
<ul>
<li><p>group the rows by epiweek(發病日), using group_by() from <strong>dplyr</strong> package</p></li>
<li><p>create a new column with local_gstar_perm() computations from <strong>sfdep</strong> package</p></li>
<li><p>unnest gi_star column of the newly created gi_stars data.frame, using unnest() from <strong>tidyr</strong> package</p></li>
</ul>
<p>The result of our code is shown below:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>gi_stars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,160 × 16
# Groups:   epiweek(發病日) [20]
   VILLENG     TOWNID                  geometry `epiweek(發病日)` location cases
   &lt;chr&gt;       &lt;chr&gt;              &lt;POLYGON [°]&gt;             &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt;
 1 Qingcao Vi… D06    ((120.1176 23.08387, 120…                31 Qingcao…     0
 2 Bao'an Vil. D32    ((120.2304 22.93544, 120…                31 Bao'an …     1
 3 Chihkan Vi… D08    ((120.2012 22.99966, 120…                31 Chihkan…     0
 4 Dacheng Vi… D02    ((120.1985 22.98147, 120…                31 Dacheng…     0
 5 Chengbei V… D06    ((120.1292 23.06512, 120…                31 Chengbe…     0
 6 Chengnan V… D06    ((120.1246 23.06904, 120…                31 Chengna…     0
 7 Fahua Vil.  D08    ((120.2094 22.98452, 120…                31 Fahua V…     0
 8 Hainan Vil. D06    ((120.175 23.02218, 120.…                31 Hainan …     0
 9 Guo'an Vil. D06    ((120.1866 23.02766, 120…                31 Guo'an …     0
10 Xixin Vil.  D06    ((120.1834 23.06086, 120…                31 Xixin V…     0
# ℹ 5,150 more rows
# ℹ 10 more variables: nb &lt;list&gt;, wt &lt;list&gt;, gi_star &lt;dbl&gt;, e_gi &lt;dbl&gt;,
#   var_gi &lt;dbl&gt;, p_value &lt;dbl&gt;, p_sim &lt;dbl&gt;, p_folded_sim &lt;dbl&gt;,
#   skewness &lt;dbl&gt;, kurtosis &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="mann-kendall-test" class="level2">
<h2 class="anchored" data-anchor-id="mann-kendall-test">7.3 Mann-Kendall Test</h2>
<p>With the Gi* measures, we can evaluate trends in each village using the Mann-Kendall test. For instance, to evaluate the trend for location Andong Village which has TOWNID D06 (denoted by location = Andong Vil. , D06) we can apply the code chunk below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>andong_mktest <span class="ot">&lt;-</span> gi_stars <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(location <span class="sc">==</span> <span class="st">"Andong Vil. , D06"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(location, <span class="st">`</span><span class="at">epiweek(發病日)</span><span class="st">`</span>, gi_star)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>andong_mktest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 3
   location          `epiweek(發病日)` gi_star
   &lt;chr&gt;                         &lt;dbl&gt;   &lt;dbl&gt;
 1 Andong Vil. , D06                31 -0.691 
 2 Andong Vil. , D06                32 -0.895 
 3 Andong Vil. , D06                33 -0.583 
 4 Andong Vil. , D06                34 -0.233 
 5 Andong Vil. , D06                35 -0.760 
 6 Andong Vil. , D06                36 -0.0642
 7 Andong Vil. , D06                37 -0.163 
 8 Andong Vil. , D06                38  0.179 
 9 Andong Vil. , D06                39  0.561 
10 Andong Vil. , D06                40  2.56  
11 Andong Vil. , D06                41  1.38  
12 Andong Vil. , D06                42  0.357 
13 Andong Vil. , D06                43  0.865 
14 Andong Vil. , D06                44  0.674 
15 Andong Vil. , D06                45  1.72  
16 Andong Vil. , D06                46  0.466 
17 Andong Vil. , D06                47  1.47  
18 Andong Vil. , D06                48  2.33  
19 Andong Vil. , D06                49 -0.153 
20 Andong Vil. , D06                50  0.493 </code></pre>
</div>
</div>
<p>Then, we can plot result using <strong>ggplot2</strong> functions to observe the Gi* statistic across different epidemiology weeks.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>andong_mktest,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span> (<span class="at">x=</span><span class="st">`</span><span class="at">epiweek(發病日)</span><span class="st">`</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">y=</span> gi_star)) <span class="sc">+</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_line</span>(<span class="at">color=</span><span class="st">"green"</span>) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">y =</span> <span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">y =</span> <span class="fl">1.96</span>) <span class="sc">+</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">y =</span> <span class="sc">-</span><span class="fl">1.96</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Take-home_Ex02_2_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In the above plot, I have also added a reference lines where</p>
<ul>
<li><p>Gi* = 0,</p></li>
<li><p>Gi* = 1.96 and</p></li>
<li><p>Gi * = -1.96.</p></li>
</ul>
<p>How should we interpret the Gi* statistics? The Gi* statistic returned for each feature in the dataset is a z-score. Since the value of z-score indicates the significance of the result,</p>
<ul>
<li><p>The more statistically significant positive (<strong>very positive value</strong>) the Gi*, the more intense the clustering of high values (<strong>hot spot</strong>).</p></li>
<li><p>The more statistically significant negative (<strong>very negative value</strong>) the Gi*, the more intense the clustering of low values (<strong>cold spot</strong>).</p></li>
</ul>
<p>With that, we will use the positivity or negativity of the Gi* statistic to determine if it is a hotspot or a coldspot. Then, we should check if Gi* &gt; 1.96 or Gi* &lt; -1.96 to determine if the hotspot/coldspot is statistically significant at 95% confidence level.</p>
<ul>
<li>Therefore, for Andong Village, it appears that weeks 40 and 46 are epidemiology weeks of significant hotspots! However, in general, there is no trend as the results for most of the other weeks are statistically insignificant at 95% confidence level.</li>
</ul>
<p><em>As there are too many villages, I am unable to display the result for every single village in this website. However, I have created a <strong>ShinyApp</strong> website in which you can select any combination of and compare the <strong>trends of different villages in Tainan City, Taiwan <a href="https://binhuiong.shinyapps.io/MannKendall_Tainan/">here</a></strong>!</em></p>
<p>Alternatively, rather than creating static plots, we can create an interactive plot using ggplotly() of <strong>plotly</strong> package to plot the Gi* results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> andong_mktest,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">`</span><span class="at">epiweek(發病日)</span><span class="st">`</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> gi_star)) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">y =</span> <span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">y =</span> <span class="fl">1.96</span>) <span class="sc">+</span> </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">y =</span> <span class="sc">-</span><span class="fl">1.96</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-c96001c959fd36de4ae4" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-c96001c959fd36de4ae4">{"x":{"data":[{"x":[31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50],"y":[-0.6905617218773169,-0.89487666158684509,-0.58268633022295602,-0.23322181258246677,-0.76017026084778505,-0.064164747325410873,-0.16321853236364853,0.1789180376758196,0.56103819606268013,2.5601304580946689,1.3786703677748946,0.35659029040342077,0.86501436444085433,0.67434066350809363,1.7230775348792646,0.46573363103055343,1.4689480011139728,2.3331787546899858,-0.15302051479043507,0.49287796133018957],"text":["epiweek(發病日): 31<br />gi_star: -0.69056172","epiweek(發病日): 32<br />gi_star: -0.89487666","epiweek(發病日): 33<br />gi_star: -0.58268633","epiweek(發病日): 34<br />gi_star: -0.23322181","epiweek(發病日): 35<br />gi_star: -0.76017026","epiweek(發病日): 36<br />gi_star: -0.06416475","epiweek(發病日): 37<br />gi_star: -0.16321853","epiweek(發病日): 38<br />gi_star:  0.17891804","epiweek(發病日): 39<br />gi_star:  0.56103820","epiweek(發病日): 40<br />gi_star:  2.56013046","epiweek(發病日): 41<br />gi_star:  1.37867037","epiweek(發病日): 42<br />gi_star:  0.35659029","epiweek(發病日): 43<br />gi_star:  0.86501436","epiweek(發病日): 44<br />gi_star:  0.67434066","epiweek(發病日): 45<br />gi_star:  1.72307753","epiweek(發病日): 46<br />gi_star:  0.46573363","epiweek(發病日): 47<br />gi_star:  1.46894800","epiweek(發病日): 48<br />gi_star:  2.33317875","epiweek(發病日): 49<br />gi_star: -0.15302051","epiweek(發病日): 50<br />gi_star:  0.49287796"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(0,0,0,1)","dash":"solid"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50],"y":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"text":["epiweek(發病日): 31<br />gi_star: 0","epiweek(發病日): 32<br />gi_star: 0","epiweek(發病日): 33<br />gi_star: 0","epiweek(發病日): 34<br />gi_star: 0","epiweek(發病日): 35<br />gi_star: 0","epiweek(發病日): 36<br />gi_star: 0","epiweek(發病日): 37<br />gi_star: 0","epiweek(發病日): 38<br />gi_star: 0","epiweek(發病日): 39<br />gi_star: 0","epiweek(發病日): 40<br />gi_star: 0","epiweek(發病日): 41<br />gi_star: 0","epiweek(發病日): 42<br />gi_star: 0","epiweek(發病日): 43<br />gi_star: 0","epiweek(發病日): 44<br />gi_star: 0","epiweek(發病日): 45<br />gi_star: 0","epiweek(發病日): 46<br />gi_star: 0","epiweek(發病日): 47<br />gi_star: 0","epiweek(發病日): 48<br />gi_star: 0","epiweek(發病日): 49<br />gi_star: 0","epiweek(發病日): 50<br />gi_star: 0"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(0,0,0,1)","dash":"solid"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50],"y":[1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96,1.96],"text":["epiweek(發病日): 31<br />gi_star: 1.96","epiweek(發病日): 32<br />gi_star: 1.96","epiweek(發病日): 33<br />gi_star: 1.96","epiweek(發病日): 34<br />gi_star: 1.96","epiweek(發病日): 35<br />gi_star: 1.96","epiweek(發病日): 36<br />gi_star: 1.96","epiweek(發病日): 37<br />gi_star: 1.96","epiweek(發病日): 38<br />gi_star: 1.96","epiweek(發病日): 39<br />gi_star: 1.96","epiweek(發病日): 40<br />gi_star: 1.96","epiweek(發病日): 41<br />gi_star: 1.96","epiweek(發病日): 42<br />gi_star: 1.96","epiweek(發病日): 43<br />gi_star: 1.96","epiweek(發病日): 44<br />gi_star: 1.96","epiweek(發病日): 45<br />gi_star: 1.96","epiweek(發病日): 46<br />gi_star: 1.96","epiweek(發病日): 47<br />gi_star: 1.96","epiweek(發病日): 48<br />gi_star: 1.96","epiweek(發病日): 49<br />gi_star: 1.96","epiweek(發病日): 50<br />gi_star: 1.96"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(0,0,0,1)","dash":"solid"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50],"y":[-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96,-1.96],"text":["epiweek(發病日): 31<br />gi_star: -1.96","epiweek(發病日): 32<br />gi_star: -1.96","epiweek(發病日): 33<br />gi_star: -1.96","epiweek(發病日): 34<br />gi_star: -1.96","epiweek(發病日): 35<br />gi_star: -1.96","epiweek(發病日): 36<br />gi_star: -1.96","epiweek(發病日): 37<br />gi_star: -1.96","epiweek(發病日): 38<br />gi_star: -1.96","epiweek(發病日): 39<br />gi_star: -1.96","epiweek(發病日): 40<br />gi_star: -1.96","epiweek(發病日): 41<br />gi_star: -1.96","epiweek(發病日): 42<br />gi_star: -1.96","epiweek(發病日): 43<br />gi_star: -1.96","epiweek(發病日): 44<br />gi_star: -1.96","epiweek(發病日): 45<br />gi_star: -1.96","epiweek(發病日): 46<br />gi_star: -1.96","epiweek(發病日): 47<br />gi_star: -1.96","epiweek(發病日): 48<br />gi_star: -1.96","epiweek(發病日): 49<br />gi_star: -1.96","epiweek(發病日): 50<br />gi_star: -1.96"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(0,0,0,1)","dash":"solid"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":26.228310502283108,"r":7.3059360730593621,"b":40.182648401826498,"l":37.260273972602747},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[30.050000000000001,50.950000000000003],"tickmode":"array","ticktext":["35","40","45","50"],"tickvals":[35,40,45,50],"categoryorder":"array","categoryarray":["35","40","45","50"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.6529680365296811,"tickwidth":0.66417600664176002,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":{"text":"epiweek(發病日)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-1.0676270175709208,2.7328808140787446],"tickmode":"array","ticktext":["-1","0","1","2"],"tickvals":[-1,0,0.99999999999999978,1.9999999999999998],"categoryorder":"array","categoryarray":["-1","0","1","2"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.6529680365296811,"tickwidth":0.66417600664176002,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"x","title":{"text":"gi_star","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.8897637795275593,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"796e4bd2b257":{"x":{},"y":{},"type":"scatter"},"796e75ba94a4":{"x":{},"y":{}},"796e2c74d75e":{"x":{},"y":{}},"796e2ae7731f":{"x":{},"y":{}}},"cur_data":"796e4bd2b257","visdat":{"796e4bd2b257":["function (y) ","x"],"796e75ba94a4":["function (y) ","x"],"796e2c74d75e":["function (y) ","x"],"796e2ae7731f":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We can perform the above steps for any village we’re interested in!</p>
</section>
<section id="performing-emerging-hotspot-analysis-ehsa" class="level2">
<h2 class="anchored" data-anchor-id="performing-emerging-hotspot-analysis-ehsa">7.4 Performing Emerging Hotspot Analysis (EHSA)</h2>
<p>Now… the exciting part! We would be checking which villages exhibit trends!</p>
<section id="performing-ehsa" class="level3">
<h3 class="anchored" data-anchor-id="performing-ehsa">7.4.1 Performing EHSA</h3>
<p>To perform EHSA, we can use emerging_hotspot_analysis() from the <strong>sfdep</strong> package.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ehsa <span class="ot">&lt;-</span> <span class="fu">emerging_hotspot_analysis</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> dengue_st,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.var =</span> <span class="st">"cases"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">1</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsim =</span> <span class="dv">79</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the code above, the arguments:</p>
<ul>
<li><p>x is the spacetime object</p></li>
<li><p>.var is the variable we want to test</p></li>
<li><p>k = nsim is the last simulations we want to stop run (we start at the 0th simulation)</p></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ehsa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  location               tau  p_value classification     
  &lt;chr&gt;                &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;              
1 Qingcao Vil. , D06   0.611 0.000191 no pattern detected
2 Bao'an Vil. , D32   -0.453 0.00582  no pattern detected
3 Chihkan Vil. , D08   0.621 0.000147 no pattern detected
4 Dacheng Vil. , D02   0.358 0.0297   no pattern detected
5 Chengbei Vil. , D06  0.611 0.000191 no pattern detected
6 Chengnan Vil. , D06  0.284 0.0855   no pattern detected</code></pre>
</div>
</div>
</section>
<section id="visualizing-the-distribution-of-ehsa-classes" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-distribution-of-ehsa-classes">7.4.2 Visualizing the distribution of EHSA classes</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> ehsa,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x=</span>classification)) <span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="images/ehsa class dist.png" class="img-fluid"></p>
<p>From the visualization, it seems like all villages have no pattern detected in terms of distribution. How significant is this result though?</p>
</section>
<section id="visualizing-ehsa" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-ehsa">7.4.3 Visualizing EHSA</h3>
<p>To examine the significance of the conclusion “all villages have no significant trend detected in terms of number of dengue cases”, we can visualize the EHSA and it’s p-value.</p>
<p>Firstly, we derive the EHSA of each village by using left_join() from the <strong>dplyr</strong> package to insert the EHSA values to each village in our study area.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>taiwanstudy_ehsa <span class="ot">&lt;-</span> taiwanstudy_sf <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(ehsa, <span class="fu">join_by</span> (location))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, we use <strong>tmap</strong> functions to create the choropleth map.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>ehsa_sig <span class="ot">&lt;-</span> taiwanstudy_ehsa <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_value <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(taiwanstudy_ehsa) <span class="sc">+</span> </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(ehsa_sig) <span class="sc">+</span> </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"classification"</span>) <span class="sc">+</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="images/ehsa_sig.png" class="img-fluid"></p>
<p>In the above code, we are highlighting only regions that exhibit significance in having “no trend detected”. It seems that there are a large number of villages (in turquoise) with no significant trends detected over the epidemiology weeks of 35-50 in year 2023!</p>
<p>On the other hand, the grey villages do not exhibit significance in having “no trend detected” over the epidemiology weeks of 35-50 in year 2023.</p>
</section>
</section>
</section>
<section id="reflection" class="level1">
<h1>8 Reflection</h1>
<p>This take-home exercise gave me the opportunity to work with real disease data in another country, to hone my skills and deepen my understanding of various types of analyses and statistics to assess the randomess of attributes across geographical regions, detect clusters and outliers and their corresponding significances, and spot regions that are undergoing trends in attributes.</p>
<p>Moreover, it sharpened my skills in data cleaning – for instance, after some analysis, I faced the problem (and weird issue) of having a village produce different number of dengue cases in the same week. This forced me to backtrack to check on my data cleaning – and I discovered that there are villages with the same names in Tainan, spread across different regions! This was a good reminder of the importance of understanding the geographical data I am studying.</p>
<p>I hope you enjoyed reading through this work, and gaining insights from the analyses!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>